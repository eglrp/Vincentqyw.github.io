<!DOCTYPE html><html class="theme-next gemini" lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="google-site-verification" content="u46QTaG_Dv3OZLpOBKYtqyuiNtIdnhSG5ASKoNvGBCM"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3"><link rel="mask-icon" href="/images/safari-pinned-tab.svg?v=5.1.3" color="#222"><link rel="manifest" href="/images/manifest.json"><meta name="msapplication-config" content="/images/browserconfig.xml"><meta name="keywords" content="Light Field,Matlab光场工具包,光场,计算成像,"><link rel="alternate" href="/atom.xml" title="Vincent Qin" type="application/atom+xml"><meta name="description" content="这里我汇总了有关光场（Light Field）一些有用的链接以及光场数据的处理过程。目前还在整理中，随时更新。声明：一切理解都是本人观点，如有疑问，还望在评论中留言。如需转载请与本人联系，谢谢合作! 邮箱：点我"><meta name="keywords" content="Light Field,Matlab光场工具包,光场,计算成像"><meta property="og:type" content="article"><meta property="og:title" content="Light Field 光场以及MATLAB光场工具包(LightField ToolBox)的使用说明"><meta property="og:url" content="https://www.vincentqin.tech/posts/LightField-Toolbox/index.html"><meta property="og:site_name" content="Vincent Qin"><meta property="og:description" content="这里我汇总了有关光场（Light Field）一些有用的链接以及光场数据的处理过程。目前还在整理中，随时更新。声明：一切理解都是本人观点，如有疑问，还望在评论中留言。如需转载请与本人联系，谢谢合作! 邮箱：点我"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/18-1-13/91252468.jpg"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/LF-cameras.jpg"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/lfp_list.png"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/LF-TB-main.png"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/LF-TB-files.png"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/LF-TB.png"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/folder-structure-raw.png"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/white-image-files-folders.png"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/folder-structure.png"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/white-image-macro-pixels.png"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/running-process.png"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/deer.jpg"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/deer-zoom-in.png"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/all-views-raw.png"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/all-views-freq-correction.png"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/all-views-freq-color-correction.png"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/concatImg.png"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/lytro-desktop-1.jpg"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/lytro-desktop-3.jpg"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/lytro-desktop-2.jpg"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/color-depth.jpg"><meta property="og:image" content="http://oofx6tpf6.bkt.clouddn.com/refocusing.jpg"><meta property="og:updated_time" content="2018-01-28T14:55:30.000Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Light Field 光场以及MATLAB光场工具包(LightField ToolBox)的使用说明"><meta name="twitter:description" content="这里我汇总了有关光场（Light Field）一些有用的链接以及光场数据的处理过程。目前还在整理中，随时更新。声明：一切理解都是本人观点，如有疑问，还望在评论中留言。如需转载请与本人联系，谢谢合作! 邮箱：点我"><meta name="twitter:image" content="http://oofx6tpf6.bkt.clouddn.com/18-1-13/91252468.jpg"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.3",sidebar:{position:"left",display:"hide",offset:10,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!1,async:!0,transition:{post_block:"bounceLeftIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://www.vincentqin.tech/posts/LightField-Toolbox/"><title>Light Field 光场以及MATLAB光场工具包(LightField ToolBox)的使用说明 | Vincent Qin</title><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-97856334-1","auto"),ga("send","pageview")</script><script type="text/javascript">var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c6e58e5665d2cb4a832117302943c909";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" type="text/css" href="/assets/css/DPlayer.min.css"><script src="/assets/js/DPlayer.min.js"></script></head><body itemscope itemtype="http://schema.org/WebPage" lang="en"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><a href="https://www.github.com/Vincentqyw" class="github-corner" aria-label="View source on Github"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Vincent Qin</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">Keep Your Curiosity</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Timelines</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>Categories</a></li><li class="menu-item menu-item-collections"><a href="/collections" rel="section"><i class="menu-item-icon fa fa-fw fa-diamond"></i><br>Collections</a></li><li class="menu-item menu-item-guest_comments"><a href="/guestbook" rel="section"><i class="menu-item-icon fa fa-fw fa-send"></i><br>Messager</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="menu-item-icon fa fa-fw fa-calendar"></i><br>Schedule</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>Search</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal post-sticky" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://www.vincentqin.tech/posts/LightField-Toolbox/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Vincent Qin"><meta itemprop="description" content=""><meta itemprop="image" content="/images/qin.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Vincent Qin"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Light Field 光场以及MATLAB光场工具包(LightField ToolBox)的使用说明</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-16T10:45:54+08:00">2017-02-16 </time><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">Post modified&#58;</span> <time title="Post modified" itemprop="dateModified" datetime="2018-01-28T22:55:30+08:00">2018-01-28 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/计算机视觉/" itemprop="url" rel="index"><span itemprop="name">计算机视觉</span> </a></span></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/posts/LightField-Toolbox/#comments" itemprop="discussionUrl"><span class="post-comments-count gitment-comments-count" data-xid="/posts/LightField-Toolbox/" itemprop="commentsCount"></span> </a></span><span id="/posts/LightField-Toolbox/" class="leancloud_visitors" data-flag-title="Light Field 光场以及MATLAB光场工具包(LightField ToolBox)的使用说明"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="post-meta-item-text">Visitors&#58;</span> <span class="leancloud-visitors-count"></span></span></div></header><div class="post-body" itemprop="articleBody"><p><img src="http://oofx6tpf6.bkt.clouddn.com/18-1-13/91252468.jpg" alt="Magic Leap"></p><div class="note success"><p><a href="https://www.vincentqin.tech/collections/">这里</a>我汇总了有关光场（Light Field）一些有用的链接以及光场数据的处理过程。目前还在整理中，随时更新。<br><span id="inline-red">声明</span>：<u><strong>一切理解都是本人观点，如有疑问，还望在</strong>评论<strong>中留言。如需转载请与本人联系，谢谢合作</strong></u>! 邮箱：<a href="/about">点我</a></p></div><a id="more"></a><h2 id="光场相机"><a href="#光场相机" class="headerlink" title="光场相机"></a>光场相机</h2><p>大家在刚刚入手光场领域的时候可能会用到目前消费级的手持光场相机，如Lytro或者ILLUM，如图（实验室的设备，我可买不起ILLUM）：<br><img src="http://oofx6tpf6.bkt.clouddn.com/LF-cameras.jpg" alt=""></p><h2 id="获取-LFP-or-LFR-原文件"><a href="#获取-LFP-or-LFR-原文件" class="headerlink" title="获取.LFP(or .LFR)原文件"></a>获取.LFP(or .LFR)原文件</h2><p>由Lytro拍摄的图像的原格式是.lfp格式，我们要将其解码成我们需要的格式。<br>工具：<strong>Lytro Desktop</strong>，<strong>MATLAB光场工具包</strong>（很强大，推荐，本文介绍该方法）。</p><p>首先用数据线把设备连接到电脑，打开Lytro Desktop，点击想要导入的图片，选中点击右上角立即处理，然后打开我的电脑图片-&gt;Lytro Desktop\Libraries\Lytro 图库.lytrolibrary*，就可以发现有很多文件夹名字是一串很长数字字母云云。点击进去可以发现里面有几个文件，以lytro为例，这几个文件如下形式：<br><img src="http://oofx6tpf6.bkt.clouddn.com/lfp_list.png" alt=""></p><p><strong><font color="red">raw.lfp</font></strong>就是我们需要的原文件，之后我们就要利用Matlab光场工具包对其进行解码操作。</p><h2 id="Matlab-Light-Field-ToolBox-光场工具箱-的使用"><a href="#Matlab-Light-Field-ToolBox-光场工具箱-的使用" class="headerlink" title="Matlab Light Field ToolBox(光场工具箱)的使用"></a>Matlab Light Field ToolBox(光场工具箱)的使用</h2><h3 id="下载光场工具包（LFToolBox）"><a href="#下载光场工具包（LFToolBox）" class="headerlink" title="下载光场工具包（LFToolBox）"></a>下载光场工具包（LFToolBox）</h3><p>首先下载<a href="http://cn.mathworks.com/matlabcentral/fileexchange/49683-light-field-toolbox-v0-4" target="_blank" rel="external">光场工具箱</a>并仔细阅读说明文档，根据文档把相应的数据拷贝到工具箱的文件夹下(这一步很关键，要仔细配置)。<del>如果不想在官网下载的话我上传到了度娘的云盘链接：<a href="http://pan.baidu.com/s/1hsDo0ks" target="_blank" rel="external">链接</a> 密码：yykc。这是我修改后的一个版本，可以直接运行。</del><strong><font color="red">另外我在Github上传了一个版本，大家可以git clone<a href="https://github.com/Vincentqyw/Light_Field_TB" target="_blank" rel="external">链接</a></font></strong>。下载下来的工具包是这样的：</p><p><img src="http://oofx6tpf6.bkt.clouddn.com/LF-TB-main.png" alt=""></p><p>LFToolbox0.4就是我们需要的工具包，该工具包里包含很多函数，如下图：</p><p><img src="http://oofx6tpf6.bkt.clouddn.com/LF-TB-files.png" alt=""></p><p>在此，我把一些比较常用的函数及文档用红色的框标注出来，其中PDF文档是该工具包的说明书。这个说明书中详细地介绍了该工具包的使用方法，我们完全可以根据该文档的介绍来实现自己想要的功能。如下是该说明书的截图：</p><p><img src="http://oofx6tpf6.bkt.clouddn.com/LF-TB.png" alt=""></p><p>该说明文档提供了各种函数用于从LFP文件中提取出自己需要的各种信息：白图像(white image)，Raw Image，对齐后的图像，以及颜色校正，频域滤波后的图像等。<br><del>因为时间不足没有整理的，感觉大家都对这个过程比较感兴趣，我觉得有必要写一下到底如何读取lfp、lfr、raw文件了。好了言归正传，开写。</del></p><h3 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h3><h4 id="step-1-创建自己的工作目录"><a href="#step-1-创建自己的工作目录" class="headerlink" title="step 1: 创建自己的工作目录"></a>step 1: 创建自己的工作目录</h4><p><u>如果是直接clone我在github上的<a href="https://github.com/Vincentqyw/Light_Field_TB" target="_blank" rel="external">工程</a>的话直接跳转<strong>step 2</strong></u>。如果没有，那就要建立自己的工作目录，便于文件的管理。这一步是必要的，如果建立的目录不一致，可能导致程序无法运行，这也是我当时初次用这个工具包时常常出错的地方。好了，建立这样的目录结构：<br><img src="http://oofx6tpf6.bkt.clouddn.com/folder-structure-raw.png" alt=""></p><h4 id="step-2-根据相机序列号修改文件名"><a href="#step-2-根据相机序列号修改文件名" class="headerlink" title="step 2: 根据相机序列号修改文件名"></a>step 2: 根据相机序列号修改文件名</h4><p><strong><font color="red">Sample_test</font></strong>表示我们的测试目录，里面包含了相机信息以及自己拍摄照片的图像（lfp/lfr）。<br><strong><font color="red">Cameras</font></strong> 这个目录中又包含了几个文件夹，它们分别是以“A”或者“B”开头，在其后面有一长串数字。这其实就是光场相机的serial number，我们可以从默认目录<u> c:\Users\<username>\AppData\Local\Lytro\cameras\sn- serial_number</username></u>中找到，这个数字每个相机不一样，大家根据自己的相机序列号修改这个目录哈。”A”表示的是LYTRO系列相机，“B”表示ILLUM系列相机；以上图为例，”A303134427”就是我相机的序列号。</p><h4 id="step-3-把白图像文件拷贝到相应的文件夹下"><a href="#step-3-把白图像文件拷贝到相应的文件夹下" class="headerlink" title="step 3: 把白图像文件拷贝到相应的文件夹下"></a>step 3: 把白图像文件拷贝到相应的文件夹下</h4><p>在每个序列号文件夹下又有一个文件夹<strong><font color="red">WhiteImages</font></strong>，这里面放着由该相机拍摄的白图像。所谓白图像就是一张由光场相机拍摄的白色的图像，当然自己也可以拿着光场相机对着白色的墙面拍几张，但是效果并不一定很好。庆幸的是LYTRO官方提供了白图像，以Lytro为例，我们可以从以下目录找到:<u> c:\Users\ <strong>username</strong>\AppData\Local\Lytro\cameras\sn- serial_number</u>。如下图所示：</p><p><img src="http://oofx6tpf6.bkt.clouddn.com/white-image-files-folders.png" alt=""></p><p>我们发现这里有以下4个文件：<strong>data.C.0/1/2/3</strong>，这是官方把白图像压缩成了这种格式，我们需要用工具箱进行解码。我们需要的正是这四个文件，拷贝出这4个文件，放在<strong><font color="red">WhiteImages</font></strong>文件夹里。这一步相当关键，一定要确保拷贝对了目录。<strong><font color="red">注意</font></strong>，Illum相机的白图像与Lytro的白图像的存放位置不一样，在<a href="#Whiteimage-Illum">相机的SD</a>卡里。</p><h4 id="step-4-将测试文件放到Images目录"><a href="#step-4-将测试文件放到Images目录" class="headerlink" title="step 4: 将测试文件放到Images目录"></a>step 4: 将测试文件放到Images目录</h4><p><strong><font color="red">Images</font></strong>文件夹下包含我们需要处理的文件们，<strong><font color="red">F01</font></strong>下存放LYTRO系列拍摄的文件，<strong><font color="red">B01</font></strong>下存放ILLUM系列拍摄的文件。以Lytro为例，由于前面已经有了测试文件<strong><font color="red">raw.lfp</font></strong>，我们就把这个文件放在<strong><font color="red">F01</font></strong>下。经过我们上述的过程之后，最后我们的目录会变成这样（注意：<u>Sample_test与LFToolBox0.4为同级目录，各个文件夹的名字务必正确</u>）：</p><p><img src="http://oofx6tpf6.bkt.clouddn.com/folder-structure.png" alt=""></p><h3 id="测试开始"><a href="#测试开始" class="headerlink" title="测试开始"></a>测试开始</h3><p>我用的是实验室的电脑，配置是：<strong>Intel(R) Core(TM) i7-4790 CPU @3.60GHz 3.60GHz RAM 16GB</strong>。其中的Demo文件是本人编写的一小段测试代码，已经贴在了文末。接下来的过程就是RUN CODE了。程序大致可以分为以下几个测试：</p><ol><li>处理白图像</li><li>解码LFP文件</li><li>频域滤波</li><li>颜色校正</li></ol><h4 id="处理白图像"><a href="#处理白图像" class="headerlink" title="处理白图像"></a>处理白图像</h4><p>处理白图像的目的是得到相机的某些参数，我当时是为了获得每幅光场的中心点坐标才进行的这一步。白图像拍摄的场景没有纹理，此时可以清楚的观察到微透镜成像的边界信息。如下图所示：</p><p><img src="http://oofx6tpf6.bkt.clouddn.com/white-image-macro-pixels.png" alt=""></p><p>可以看到的是，微透镜下成像是这种正六边形的网格，类似于蜂窝的结构，感觉很酷有木有。需要注意的是，该过程不是简单地提取出一张白图像来，而是提取几十张白图像对（image pairs），这个过程运行起来有点久，以下是运行的截图：</p><p><img src="http://oofx6tpf6.bkt.clouddn.com/running-process.png" alt=""></p><h4 id="解码LFP文件"><a href="#解码LFP文件" class="headerlink" title="解码LFP文件"></a>解码LFP文件</h4><p>如果只是单纯地读出LFP/LFR、RAW文件的数据的话可以分别用工具包提供的如下函数：LFReadLFP、LFReadRaw。注意两个函数的返回值不一样。LFReadLFP返回一个结构体类型的变量，它包含相机的各个信息，我们可以根据自己的需要保留数据。LFReadRaw返回的是一张uint16的灰度图，还没有经过demosaicing操作。去马赛克操作在malatb中有相应的函数，这点不用担心。我们在这里不是直接调用的LFReadLFP而是调用了工具箱提供的LFLytroDecodeImage函数。如果运行有问题（<u>若是直接clone我github上项目的话，不需要修改</u>），将LFLytroDecodeImage中的WhiteImageDatabase路径由以下：</p><figure class="highlight matlab"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">DecodeOptions = LFDefaultField( <span class="string">'DecodeOptions'</span>, <span class="string">'WhiteImageDatabasePath'</span>...</div><div class="line">,fullfile(<span class="string">'Cameras'</span>,<span class="string">'WhiteImageDatabase.mat'</span>));<span class="comment">% line 71</span></div></pre></td></tr></table></figure><p>改为：</p><figure class="highlight matlab"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">DecodeOptions = LFDefaultField( <span class="string">'DecodeOptions'</span>, <span class="string">'WhiteImageDatabasePath'</span>...</div><div class="line"> ,fullfile(<span class="string">'Cameras'</span>,LFMetadata.SerialData.camera.serialNumber,<span class="string">'WhiteImageDatabase.mat'</span>));</div><div class="line"><span class="comment">%== 注意，这条插在  ---Select appropriate white image---上行，而不是在原来的71行修改==。</span></div></pre></td></tr></table></figure><p>经过这样的修改之后，这下应该可以跑了。我们可以得到以下图像：</p><center><img src="http://oofx6tpf6.bkt.clouddn.com/deer.jpg" width="80%"></center><p>局部放大效果图：</p><center><img src="http://oofx6tpf6.bkt.clouddn.com/deer-zoom-in.png" width="80%"></center><p>所有视角的图像：</p><center><img src="http://oofx6tpf6.bkt.clouddn.com/all-views-raw.png" width="80%"></center><p>这时候可以看到在边界视角上的图像比较黑，所以我们接下来要进行频域滤波，以及颜色校正。</p><h4 id="频域滤波以及颜色校正"><a href="#频域滤波以及颜色校正" class="headerlink" title="频域滤波以及颜色校正"></a>频域滤波以及颜色校正</h4><p>这部分分别用到了LFFilt4DFFT以及LFColourCorrect函数。以LYTRO 1.0 为例子，我们得到的光场图像一种有11*11个视角，但是这个121个视角子孔径图像的质量真的不敢恭维，尤其是边角处的视角(u=1,v=1)时，这个图像时完全变成黑色的。所以嘛，LFFilt4DFFT这个函数是将这些变成黑色的图像或者质量不好的图像进行校正的，具体原理不作展开。LFColourCorrect这个函数是利用gamma变化对原始图像进行颜色校正的，这一点比较简单。总之利用这两个函数能够让我们得到的光场图像的质量更好，当然你也可以选择不用。</p><p>以下是经过滤波之后的所有子孔径图像，可以发现边界的视角相比于频域滤波之前有了很好的可视性。</p><center><img src="http://oofx6tpf6.bkt.clouddn.com/all-views-freq-correction.png" width="80%"></center><p>以下是经过颜色校正之后的所有所有子孔径图像。</p><center><img src="http://oofx6tpf6.bkt.clouddn.com/all-views-freq-color-correction.png" width="80%"></center><p>经过以上的步骤我们可以学习到白图像的处理，以及光场图像的处理等操作。当然我没有列出这个工具包所有的功能介绍，大家可以根据需要建立自己工程，对自己的数据进行测试，以上！</p><h2 id="注意事项及测试代码"><a href="#注意事项及测试代码" class="headerlink" title="注意事项及测试代码"></a><strong><font color="red">注意事项及测试代码</font></strong></h2><h3 id="参数设置好了再Run"><a href="#参数设置好了再Run" class="headerlink" title="参数设置好了再Run"></a><span id="Whiteimage-Illum">参数设置好了再Run</span></h3><p>不少同学是因为设置不当，导致运行错误，以下我列举了可能出现错误的地方。</p><ul><li>务必在WhiteImagesPath处写明相机型号，确定好到底是Lytro还是Illum</li><li>注意Illum相机的配对数据在相机的SD卡中，解压<code>caldata-Bxxxxxxxxx.tar</code>，将里面的文件拷贝出来放在路径<strong>Sample_test\Cameras\Bxxxxxxxxx\</strong>下即可</li><li>白图像的处理过程比较久，耐心等待就行即可</li><li>Lytro与Illum的频域滤波调用函数是不同的，我已经把代码添加在了相应位置；这个函数用时较久，耐心等待</li><li>结果存放在<strong>Results_saving</strong>文件夹下</li><li>再次提醒，由于Illum图像的分辨率比较大，所以当程序运行到LFLytroDecodeImage以及频域滤波时会造成内存以及磁盘的大量使用，慎重考虑。</li><li>如有Bug请及时联系我，请在评论区留言。</li></ul><h3 id="没有图像文件怎么搞"><a href="#没有图像文件怎么搞" class="headerlink" title="没有图像文件怎么搞"></a>没有图像文件怎么搞</h3><ol><li>下载整个<a href="https://github.com/Vincentqyw/light-field-TB" target="_blank" rel="external">工程</a>；</li><li>下载数据集：可以在<a href="https://www.irisa.fr/temics/demos/lightField/index.html" target="_blank" rel="external">这里</a>下载Lytro数据集，该数据集包括白图像以及图像原文件；</li><li>然后将工程<code>Sample_test/Cameras/</code>下的文件<code>Axxxxxxxxxxx</code>修改为<code>A303134643</code>，然后将数据集<code>LytroDataset\sn-A303134643</code>文件夹下的<code>data.C.0.1/2/3</code>放在<code>Sample_test/Cameras/A303134643</code>文件夹下；</li><li>将<code>LytroDataset\raws</code>文件夹下的图像原文件放在工程<code>Sample_test/Images/A01/</code>文件夹下；</li><li>修改<code>Demo.m</code>中<code>WhiteImagesPath=&#39;Sample_test\Cameras\Axxxxxxxxxx&#39;</code>，以及<code>lfpname=&#39;test&#39;</code>改成步骤4中的任何一个图像原文件即可。</li><li>run起来吧~</li></ol><h3 id="解码效果为何不佳"><a href="#解码效果为何不佳" class="headerlink" title="解码效果为何不佳"></a>解码效果为何不佳</h3><p>另外，很多童鞋问过我一些问题，例如<strong>为何光场工具包解码出来的图像质量如此之差，始终达不到Lytro Desktop导出图像的质量</strong>。其实该问题是个普遍现象，目前没有一个好的解决方法。光场工具包的发明者<strong>Donald Dansereau</strong>在<a href="https://plus.google.com/communities/114934462920613225440" target="_blank" rel="external">Google Plus</a>也是这么认为的，我把原话附在下面：</p><div class="note"><p>Q from email: there are differences between the toolbox decoded output and the Lytro Desktop’s image. The differences involve color, intensity and noise. How can I fix this?</p><p>A: Thanks for the email. There will always be important differences between the Lytro software output and the toolbox output. The toolbox tries to generate a 4D light field that is as close as possible to the raw image measured by the camera, while still being a standard two-plane parameterized 4D light field. The Lytro software has a very different goal. They do not produce a 4D light field, they produce 2D renders. These are optimized to look nice, and evidently look much nicer than any 2D slice taken from the toolbox output. They use sophisticated decoding and denoising techniques to do this.<br>The philosophy of the toolbox is to provide a 4D light field close to the raw image captured by the camera, to allow researchers to explore the characteristics of this kind of signal. It should, in theory, be possible to go from the 4D light field output by the toolbox to nice 2D renderings like those produced by the Lytro software. Making nice 2D renderings can also be accomplished by working directly from the lenslet image, as has been demonstrated in a few papers by researchers at Lytro and elsewhere.</p></div><p>从他的回复可以看到，他提供的<strong>光场工具包的目的是尽量提供光场相机采集的原汁原味的数据（raw data）用来逼近4D光场信息</strong>；同时让研究者去研究这些数据，为他们所用。但是Lytro公司提供<strong>Lytro desktop的目的是渲染出漂亮的2D图像，以供用户使用</strong>。以上也反映了研究和商业重要区别，Lytro并未提供他们渲染的方式，属内部机密。</p><p>此外我也单独问了Donald Dansereau同样的问题，我把他的回复建议原话附在下面：<br></p><div class="note success"><p>If you want to make nice 2D images, I suggest</p><p><strong>Filter before colour correction</strong>. Try a simple planar focus filter (LFFiltShiftSum, or one of the linear filters in the LFDemoBasicFilt* examples).</p><p><strong>Don’t use the toolbox colour correction</strong>, the code is extremely simplistic and is mostly meant to show you where the metadata is.<br>Look into some <strong>4D - to - 2D rendering techniques</strong> for light fields.</p><p>Look into some <strong>2D denoising techniques</strong> and apply them to your 2D render, or to the 4D light field slices.</p><p>If you do find something that works well for you please share, as this is a common question.</p></div><p></p><p>我习惯的参数设置：颜色校正的参数设为<strong>Gamma=0.8或者小于0.8</strong>，这个参数你可以不停地试。另外，我一般不用我公布代码里的频域滤波，因为我认为这步会很大程度地破坏原始数据。我会选用中心视角邻域的几个视角，例如原来ILLUM提供的是15x15个视角，但是我只用其中的11x11或者更少，这样就可以不用考虑边界视角黑暗的问题了。当然大家可以尝试下按照Donald Dansereau的说法进行尝试，如果大家有好的方法，也可以告诉我。（PS：以上为回复@lixiaohao同学邮件部分内容）</p><h3 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a>测试代码</h3><p>以下是Demo文件的代码，仅供学习使用。</p><figure class="highlight matlab"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div></pre></td><td class="code"><pre><div class="line">clc;</div><div class="line">clear all;</div><div class="line">clc;</div><div class="line"></div><div class="line">addpath(genpath(<span class="string">'Sample_test'</span>));</div><div class="line">addpath(genpath(<span class="string">'LFToolbox0.4'</span>));</div><div class="line"></div><div class="line">LFMatlabPathSetup;</div><div class="line"></div><div class="line"><span class="comment">%% Step1: 解压data.C.0/1/2/3---&gt;white,结果存储在Cameras中</span></div><div class="line">fprintf(<span class="string">'===============Step1: Unpack Lytro Files===============\n\n '</span>);</div><div class="line">LFUtilUnpackLytroArchive(<span class="string">'Sample_test'</span>)</div><div class="line"></div><div class="line"><span class="comment">%% Step2: 包含刚刚解压出来的文件的目录</span></div><div class="line"></div><div class="line">fprintf(<span class="string">'===============Step2: Process WhiteImages===============\n\n'</span>);</div><div class="line"></div><div class="line">WhiteImagesPath=<span class="string">'Sample_test\Cameras\B5151500510'</span>; <span class="comment">% 务必要设置这个值 B5151500510   A303134427</span></div><div class="line">LFUtilProcessWhiteImages( WhiteImagesPath);</div><div class="line"></div><div class="line"><span class="comment">%% Step3: 解码光场图像.lfp</span></div><div class="line">fprintf(<span class="string">'=====================Step3: Decode LFP===================\n\n'</span>);</div><div class="line">cd(<span class="string">'Sample_test'</span>);  <span class="comment">% 进入Sample_test目录</span></div><div class="line"></div><div class="line">lfpname=<span class="string">'baby'</span>; <span class="comment">%测试图像名称，改成你自己的</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> WhiteImagesPath(<span class="number">21</span>)==<span class="string">'A'</span>    <span class="comment">%找到型号  exist('LYTRO','var')</span></div><div class="line">    version=<span class="string">'F01'</span>;</div><div class="line"><span class="keyword">elseif</span> WhiteImagesPath(<span class="number">21</span>)==<span class="string">'B'</span><span class="comment">%找到型号  exist('ILLUM','var')</span></div><div class="line">    version=<span class="string">'B01'</span>;</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line">InputFname=[<span class="string">'Images\',version,'</span>\<span class="string">',lfpname,'</span>.lfp<span class="string">'];</span></div><div class="line"></div><div class="line">[LF, LFMetadata,WhiteImage,CorrectedLensletImage, ...</div><div class="line">WhiteImageMetadata, LensletGridModel, DecodeOptions]...</div><div class="line">                              =  LFLytroDecodeImage(InputFname);</div><div class="line">cd('..<span class="string">');</span></div><div class="line"></div><div class="line">imshow(CorrectedLensletImage) %Raw Image</div><div class="line">mkdir(['Results_saving\<span class="string">',lfpname]);</span></div><div class="line">imwrite(CorrectedLensletImage,['Results_saving\<span class="string">',lfpname,'</span>\<span class="string">',lfpname,'</span>.bmp<span class="string">']);</span></div><div class="line">save(['Results_saving\<span class="string">',lfpname,'</span>\<span class="string">',lfpname,'</span>.mat<span class="string">'],'</span>CorrectedLensletImage<span class="string">');</span></div><div class="line"></div><div class="line"></div><div class="line">%% =======================频域滤波================================</div><div class="line">%---Setup for linear filters---</div><div class="line">tic</div><div class="line">% lytro</div><div class="line">if strcmp(version,'F01<span class="string">')==1</span></div><div class="line">    LFPaddedSize = [16, 16, 400, 400];</div><div class="line">    BW = 0.03;</div><div class="line">    FiltOptions = [];</div><div class="line">    FiltOptions.Rolloff = 'Butter<span class="string">';</span></div><div class="line">    Slope1 = -3/9; % Lorikeet</div><div class="line">    Slope2 = 4/9;  % Building</div><div class="line">    fprintf('Building <span class="number">4</span>D frequency hyperfan... <span class="string">');</span></div><div class="line">    [H, FiltOptionsOut] = LFBuild4DFreqHyperfan( LFPaddedSize, Slope1, Slope2, BW, FiltOptions );</div><div class="line">    fprintf('Applying filter<span class="string">');</span></div><div class="line">    [LFFilt, FiltOptionsOut] = LFFilt4DFFT( LF, H, FiltOptionsOut );</div><div class="line"></div><div class="line">% illum</div><div class="line">elseif strcmp(version,'B01<span class="string">')==1</span></div><div class="line"></div><div class="line">    LFSize = size(LF);</div><div class="line">    LFPaddedSize = LFSize;</div><div class="line">    BW = 0.04;</div><div class="line">    FiltOptions = [];</div><div class="line">    %---Demonstrate 4D Hyperfan filter---</div><div class="line">    Slope1 = -4/15; % Lorikeet</div><div class="line">    Slope2 = 15/15; % Far background</div><div class="line">    fprintf('Building <span class="number">4</span>D frequency hyperfan... <span class="string">');</span></div><div class="line">    [H, FiltOptionsOut] = LFBuild4DFreqHyperfan( LFPaddedSize, Slope1, Slope2, BW, FiltOptions );</div><div class="line">    fprintf('Applying filter<span class="string">');</span></div><div class="line">    [LFFilt, FiltOptionsOut] = LFFilt4DFFT( LF, H, FiltOptionsOut );</div><div class="line">    title(sprintf('Frequency hyperfan filter, slopes %<span class="number">.3</span>g, %<span class="number">.3</span>g, BW %<span class="number">.3</span>g<span class="string">', Slope1, Slope2, BW));</span></div><div class="line">    drawnow</div><div class="line">    save(['Results_saving\<span class="string">',lfpname,'</span>\<span class="string">',lfpname,'</span><span class="number">5</span>D.mat<span class="string">'],'</span>LFFilt<span class="string">');</span></div><div class="line">end</div><div class="line"></div><div class="line">%% =======================颜色校正参数设置==========================                               </div><div class="line"></div><div class="line">ColMatrix = DecodeOptions.ColourMatrix;</div><div class="line">Gamma=DecodeOptions.Gamma;</div><div class="line">ColBalance=DecodeOptions.ColourBalance;</div><div class="line"></div><div class="line">% 对3280*3280的原始彩色图像进行颜色校正</div><div class="line">ColorCorrectedImage=LFColourCorrect(CorrectedLensletImage, ColMatrix, ColBalance, Gamma);</div><div class="line">imwrite(ColorCorrectedImage,['Results_saving\<span class="string">',lfpname,'</span>\<span class="string">',lfpname,'</span>ColorCorrectedImage.bmp<span class="string">']);</span></div><div class="line">save(['Results_saving\<span class="string">',lfpname,'</span>\<span class="string">',lfpname,'</span>ColorCorrectedImage.mat<span class="string">'],'</span>ColorCorrectedImage<span class="string">')</span></div><div class="line">imshow(ColorCorrectedImage);title('Corrected Lenslet Image<span class="string">');</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">%% 同样是颜色矫正， 为了得到光场数据。得到5-D LFColorCorrectedImage数据</div><div class="line">LFColorCorrectedImage=zeros(size(LF,1),size(LF,2),size(LF,3),size(LF,4),size(LF,5));</div><div class="line">for i=1:size(LF,1)</div><div class="line">    for j=1:size(LF,2)</div><div class="line">        temp =squeeze(LFFilt(i,j,:,:,1:3));</div><div class="line">        temp = LFColourCorrect(temp, ColMatrix, ColBalance, Gamma);</div><div class="line">        LFColorCorrectedImage(i,j,:,:,1:3)=temp;</div><div class="line">        imshow(temp);</div><div class="line">        pause(0.1)</div><div class="line">    end</div><div class="line">end</div><div class="line">LFColorCorrectedImage(:,:,:,:,4)=LF(:,:,:,:,4);</div><div class="line">save(['Results_saving\<span class="string">',lfpname,'</span>\<span class="string">',lfpname,'</span>RawLFColorCorrectedImage.mat<span class="string">'],'</span>LFColorCorrectedImage<span class="string">');% very important</span></div><div class="line"></div><div class="line">toc</div><div class="line">%--------------------------------------------------------------------------------</div></pre></td></tr></table></figure><hr><p><del>## Lytro官网可视化工具</del></p><p><del>谁让人家Lytro不开源呢，人家自己做的Demo还不错。通过鼠标就可以对以下图像进行<strong>重聚焦，变化视角，以及缩放</strong>等操作。话不多说，上图！</del> 呵，人家公司在2017年11月30号之后停止了对lytro live photo的线上支持，所以以下啥都没有了。<br></p><h3 id="数字重聚焦"><a href="#数字重聚焦" class="headerlink" title="数字重聚焦"></a>数字重聚焦</h3><p>利用如下的重聚焦公式可以实现光场图像的重聚焦。</p><script type="math/tex;mode=display">L_{\alpha}(x,y,u,v)=L_0(x+(1-\frac{1}{\alpha})u,y+(1-\frac{1}{\alpha})v,u,v)</script><p><img src="http://oofx6tpf6.bkt.clouddn.com/concatImg.png" alt=""><br>左图为其中心视角图像，右图为重聚焦（参数 $\alpha$ =0.5）之后的图像。</p><p>给出部分测试代码如下，全部代码见<strong><a href="https://github.com/Vincentqyw/Light-Field-Refocusing" target="_blank" rel="external">Github</a></strong>;</p><figure class="highlight matlab"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line"><span class="comment">%% This is a demo of light field refocusing</span></div><div class="line"><span class="comment">% input: LF </span></div><div class="line"><span class="comment">% ouput: refocused pinhole image</span></div><div class="line"><span class="comment">% Writen by: Vincent Qin</span></div><div class="line"><span class="comment">% Data: 2018 May 17th 21:35:14</span></div><div class="line"></div><div class="line"><span class="comment">%% Note: the input is 5D LF data  decoded from Matlab Light field Toolbox</span></div><div class="line"></div><div class="line">clc;</div><div class="line"></div><div class="line">addpath(genpath(pwd));</div><div class="line"><span class="comment">%% mex function</span></div><div class="line">cd(<span class="string">'src'</span>); </div><div class="line">mex REMAP2REFOCUS_mex.c </div><div class="line">mex BLOCKMEAN_mex.c </div><div class="line">cd ..</div><div class="line"></div><div class="line">use_vincent_data=<span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span> use_vincent_data</div><div class="line">    <span class="built_in">disp</span>(<span class="string">'Downloading LF data, please wait...'</span>);</div><div class="line"></div><div class="line">    URL=<span class="string">'http://p8vl2tjcq.bkt.clouddn.com/LF.mat'</span>;</div><div class="line">    [f, status] = urlwrite(URL,<span class="string">'input/LF_web.mat'</span>);</div><div class="line">    <span class="keyword">if</span> status == <span class="number">1</span>;</div><div class="line">        fprintf(<span class="number">1</span>,<span class="string">'Success！\n'</span>);</div><div class="line">    <span class="keyword">else</span></div><div class="line">        fprintf(<span class="number">1</span>,<span class="string">'Failed！\n'</span>);</div><div class="line">    <span class="keyword">end</span></div><div class="line">    load(<span class="string">'input/LF_web.mat'</span>);</div><div class="line"><span class="keyword">else</span></div><div class="line">    load(<span class="string">'input/your_LF_data.mat'</span>);</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="built_in">disp</span>(<span class="string">'Processing LF to Remap image...'</span>);</div><div class="line"></div><div class="line">LF=LF(:,:,:,:,<span class="number">1</span>:<span class="number">3</span>);</div><div class="line">[UV_diameter,~,y_size,x_size,c]=<span class="built_in">size</span>(LF);</div><div class="line"></div><div class="line"><span class="comment">%  get LF remap and pinhole image before refocusing</span></div><div class="line">LF_Remap = LF2Remap(LF);</div><div class="line"><span class="comment">% IM_Refoc_1 = zeros(y_size, x_size,3);temp = zeros(y_size, x_size);</span></div><div class="line"><span class="comment">% BLOCKMEAN_mex(x_size, y_size, UV_diameter, LF_Remap(:,:,1), temp);IM_Refoc_1(:,:,1)=temp;</span></div><div class="line"><span class="comment">% BLOCKMEAN_mex(x_size, y_size, UV_diameter, LF_Remap(:,:,2), temp);IM_Refoc_1(:,:,2)=temp;</span></div><div class="line"><span class="comment">% BLOCKMEAN_mex(x_size, y_size, UV_diameter, LF_Remap(:,:,3), temp);IM_Refoc_1(:,:,3)=temp;</span></div><div class="line"></div><div class="line"><span class="comment">% get params</span></div><div class="line">LF_x_size = x_size * UV_diameter;</div><div class="line">LF_y_size = y_size * UV_diameter;</div><div class="line">UV_radius = (UV_diameter<span class="number">-1</span>)/<span class="number">2</span>;</div><div class="line">UV_size   = UV_diameter*UV_diameter;</div><div class="line"></div><div class="line"><span class="comment">% collect data</span></div><div class="line">LF_parameters       = struct(...</div><div class="line">                             <span class="string">'LF_x_size'</span>,LF_x_size,...</div><div class="line">                             <span class="string">'LF_y_size'</span>,LF_y_size,...</div><div class="line">                             <span class="string">'x_size'</span>,x_size,...</div><div class="line">                             <span class="string">'y_size'</span>,y_size,...</div><div class="line">                             <span class="string">'UV_radius'</span>,(UV_diameter<span class="number">-1</span>)/<span class="number">2</span>,...</div><div class="line">                             <span class="string">'UV_diameter'</span>,UV_diameter,...</div><div class="line">                             <span class="string">'UV_size'</span>,UV_diameter*UV_diameter) ;</div><div class="line"></div><div class="line"><span class="comment">% predefine output</span></div><div class="line">LF_Remap_alpha   = <span class="built_in">zeros</span>(LF_y_size,LF_x_size,<span class="number">3</span>) ;</div><div class="line">IM_Refoc_alpha   = <span class="built_in">zeros</span>(y_size,x_size,<span class="number">3</span>)       ;</div><div class="line"></div><div class="line"><span class="comment">% here begins refocusing</span></div><div class="line"><span class="built_in">disp</span>(<span class="string">'Processing refocusing...'</span>);</div><div class="line">alpha=<span class="number">0.5</span>;    <span class="comment">%　shearing number</span></div><div class="line">REMAP2REFOCUS_mex(x_size,y_size,UV_diameter,UV_radius,LF_Remap,LF_Remap_alpha,IM_Refoc_alpha,alpha);  </div><div class="line"></div><div class="line"><span class="comment">% show figure</span></div><div class="line">central_view=<span class="built_in">squeeze</span>(LF(UV_radius+<span class="number">1</span>,UV_radius+<span class="number">1</span>,:,:,:));</div><div class="line">figure; imshow(central_view);</div><div class="line">title(<span class="string">'central view'</span>);set(gcf,<span class="string">'color'</span>,[<span class="number">1</span> <span class="number">1</span> <span class="number">1</span>]);  </div><div class="line">figure; imshow(IM_Refoc_alpha);</div><div class="line">title([<span class="string">'refocused image pinhole at alpha = '</span> num2str(alpha)]);</div><div class="line">set(gcf,<span class="string">'color'</span>,[<span class="number">1</span> <span class="number">1</span> <span class="number">1</span>]);  </div><div class="line"></div><div class="line"><span class="comment">% concat them</span></div><div class="line">concatImg=[central_view,IM_Refoc_alpha];</div><div class="line">figure;imshow(concatImg);set(gcf,<span class="string">'color'</span>,[<span class="number">1</span> <span class="number">1</span> <span class="number">1</span>]); </div><div class="line">imwrite(concatImg,<span class="string">'concatImg.png'</span>);</div></pre></td></tr></table></figure><h3 id="Lytro-Desktop"><a href="#Lytro-Desktop" class="headerlink" title="Lytro Desktop"></a>Lytro Desktop</h3><p>Lytro Desktop是曾经的Lytro官方提供的软件，可以处理由Lytro系列相机拍摄到的图像。利用该软件能够导出相机配对数据、重聚焦图像、全聚焦图、深度图、原始文件等。下面给出一些常用的导出文件。</p><ul><li>导入需要处理的图像</li></ul><p><img src="http://oofx6tpf6.bkt.clouddn.com/lytro-desktop-1.jpg" alt=""></p><ul><li>导出配对数据</li></ul><p><img src="http://oofx6tpf6.bkt.clouddn.com/lytro-desktop-3.jpg" alt=""></p><ul><li>导出待处理图像的各种格式</li></ul><p><img src="http://oofx6tpf6.bkt.clouddn.com/lytro-desktop-2.jpg" alt=""></p><ul><li>全聚焦彩色图与内置深度图</li></ul><p><img src="http://oofx6tpf6.bkt.clouddn.com/color-depth.jpg" alt=""></p><ul><li>重聚焦</li></ul><p><img src="http://oofx6tpf6.bkt.clouddn.com/refocusing.jpg" alt=""></p><ul><li>H.264电影</li></ul><div id="dplayer0" class="dplayer hexo-tag-dplayer-mark" style="margin-bottom:20px"></div><script>!function(){var d=new DPlayer({container:document.getElementById("dplayer0"),loop:!0,video:{url:"http://oofx6tpf6.bkt.clouddn.com/molly.mp4"},danmaku:{id:"4d5c01842f37d90651f9693783c6564279fed6f4",api:"https://api.prprpr.me/dplayer/"}});window.dplayers||(window.dplayers=[]),window.dplayers.push(d)}()</script><p><strong><center>以上，如有问题欢迎评论</center></strong></p></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>Thanks for Your Kindly Donation.</div><button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'><span>Donate</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"><img id="wechat_qr" src="/images/wechat_pay.png" alt="Vincent Qin WeChat Pay"><p>WeChat Pay</p></div><div id="alipay" style="display:inline-block"><img id="alipay_qr" src="/images/ali_pay.png" alt="Vincent Qin Alipay"><p>Alipay</p></div></div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author:</strong> Vincent Qin</li><li class="post-copyright-link"><strong>Post link:</strong> <a href="https://www.vincentqin.tech/posts/LightField-Toolbox/" title="Light Field 光场以及MATLAB光场工具包(LightField ToolBox)的使用说明">https://www.vincentqin.tech/posts/LightField-Toolbox/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> unless stating additionally.</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Light-Field/" rel="tag"><i class="fa fa-star"></i> Light Field</a> <a href="/tags/Matlab光场工具包/" rel="tag"><i class="fa fa-star"></i> Matlab光场工具包</a> <a href="/tags/光场/" rel="tag"><i class="fa fa-star"></i> 光场</a> <a href="/tags/计算成像/" rel="tag"><i class="fa fa-star"></i> 计算成像</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/posts/journal2JP-USA/" rel="next" title="日本与美国之行"><i class="fa fa-chevron-left"></i> 日本与美国之行</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/posts/issues-Matlab/" rel="prev" title="Matlab相关问题汇总">Matlab相关问题汇总 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"><div id="gitment-container"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/qin.png" alt="Vincent Qin"><p class="site-author-name" itemprop="name">Vincent Qin</p><p class="site-description motion-element" itemprop="description">Keep Your Curiosity.</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">26</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">10</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">72</span> <span class="site-state-item-name">tags</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/Vincentqyw" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:qin123yw@163.com" target="_blank" title="Email"><i class="fa fa-fw fa-envelope"></i>Email</a> </span><span class="links-of-author-item"><a href="https://coding.net/vincentqin" target="_blank" title="Coding"><i class="fa fa-fw fa-code"></i>Coding</a> </span><span class="links-of-author-item"><a href="https://weibo.com/273224402" target="_blank" title="Weibo"><i class="fa fa-fw fa-weibo"></i>Weibo</a> </span><span class="links-of-author-item"><a href="https://www.vincentqin.tech/images/qcode.jpg" target="_blank" title="Wechat"><i class="fa fa-fw fa-weixin"></i>Wechat</a> </span><span class="links-of-author-item"><a href="https://www.zhihu.com/people/i_vincent/activities" target="_blank" title="Zhihu"><i class="fa fa-fw fa-quora"></i>Zhihu</a></span></div><div class="links-of-blogroll motion-element links-of-blogroll-inline"><div class="links-of-blogroll-title"><i class="fa fa-fw fa-battery-1"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><a href="https://github.com/tensorboy" title="Tensorboy" target="_blank">Tensorboy</a></li><li class="links-of-blogroll-item"><a href="http://simtalk.cn/" title="Simshang" target="_blank">Simshang</a></li><li class="links-of-blogroll-item"><a href="https://sttomato.github.io" title="Tomato" target="_blank">Tomato</a></li><li class="links-of-blogroll-item"><a href="https://newdee.cf/" title="Newdee" target="_blank">Newdee</a></li><li class="links-of-blogroll-item"><a href="http://qianli666.com/" title="QianLi" target="_blank">QianLi</a></li><li class="links-of-blogroll-item"><a href="http://cs-people.bu.edu/yfhu/" title="WhoIf" target="_blank">WhoIf</a></li><li class="links-of-blogroll-item"><a href="http://yulunzhang.com/" title="Yulun" target="_blank">Yulun</a></li><li class="links-of-blogroll-item"><a href="http://yqchen.com/" title="Yanqin" target="_blank">Yanqin</a></li><li class="links-of-blogroll-item"><a href="https://sanglongbest.github.io/" title="YangLiu" target="_blank">YangLiu</a></li><li class="links-of-blogroll-item"><a href="http://www.dandyweng.com/" title="DandyWeng" target="_blank">DandyWeng</a></li></ul></div><div id="days"></div><script language="javascript">function show_date_time(){window.setTimeout("show_date_time()",1e3),BirthDay=new Date("09/15/2016 9:00:00"),today=new Date,timeold=today.getTime()-BirthDay.getTime(),sectimeold=timeold/1e3,secondsold=Math.floor(sectimeold),msPerDay=864e5,e_daysold=timeold/msPerDay,daysold=Math.floor(e_daysold),e_hrsold=24*(e_daysold-daysold),hrsold=setzero(Math.floor(e_hrsold)),e_minsold=60*(e_hrsold-hrsold),minsold=setzero(Math.floor(60*(e_hrsold-hrsold))),seconds=setzero(Math.floor(60*(e_minsold-minsold))),document.getElementById("days").innerHTML="Running "+daysold+"DAYS "+hrsold+":"+minsold+":"+seconds}function setzero(e){return e<10&&(e="0"+e),e}show_date_time()</script></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#光场相机"><span class="nav-number">1.</span> <span class="nav-text">光场相机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#获取-LFP-or-LFR-原文件"><span class="nav-number">2.</span> <span class="nav-text">获取.LFP(or .LFR)原文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Matlab-Light-Field-ToolBox-光场工具箱-的使用"><span class="nav-number">3.</span> <span class="nav-text">Matlab Light Field ToolBox(光场工具箱)的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载光场工具包（LFToolBox）"><span class="nav-number">3.1.</span> <span class="nav-text">下载光场工具包（LFToolBox）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#前期准备"><span class="nav-number">3.2.</span> <span class="nav-text">前期准备</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#step-1-创建自己的工作目录"><span class="nav-number">3.2.1.</span> <span class="nav-text">step 1: 创建自己的工作目录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step-2-根据相机序列号修改文件名"><span class="nav-number">3.2.2.</span> <span class="nav-text">step 2: 根据相机序列号修改文件名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step-3-把白图像文件拷贝到相应的文件夹下"><span class="nav-number">3.2.3.</span> <span class="nav-text">step 3: 把白图像文件拷贝到相应的文件夹下</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#step-4-将测试文件放到Images目录"><span class="nav-number">3.2.4.</span> <span class="nav-text">step 4: 将测试文件放到Images目录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试开始"><span class="nav-number">3.3.</span> <span class="nav-text">测试开始</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#处理白图像"><span class="nav-number">3.3.1.</span> <span class="nav-text">处理白图像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解码LFP文件"><span class="nav-number">3.3.2.</span> <span class="nav-text">解码LFP文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#频域滤波以及颜色校正"><span class="nav-number">3.3.3.</span> <span class="nav-text">频域滤波以及颜色校正</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注意事项及测试代码"><span class="nav-number">4.</span> <span class="nav-text">注意事项及测试代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#参数设置好了再Run"><span class="nav-number">4.1.</span> <span class="nav-text">参数设置好了再Run</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#没有图像文件怎么搞"><span class="nav-number">4.2.</span> <span class="nav-text">没有图像文件怎么搞</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解码效果为何不佳"><span class="nav-number">4.3.</span> <span class="nav-text">解码效果为何不佳</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试代码"><span class="nav-number">4.4.</span> <span class="nav-text">测试代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数字重聚焦"><span class="nav-number">4.5.</span> <span class="nav-text">数字重聚焦</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lytro-Desktop"><span class="nav-number">4.6.</span> <span class="nav-text">Lytro Desktop</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2018</span> <span class="with-love" id="heart"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Vincent Qin</span></div><div class="footer-custom">Hosted by <a href="https://pages.coding.me" id="coding">Coding Pages</a></div><div class="busuanzi-count"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="site-uv"><i class="fa fa-user-circle-o"></i> <span class="busuanzi-value" id="busuanzi_value_site_uv"></span> </span><span class="site-pv"><i class="fa fa-eye"></i> <span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div><div style="display:none"><script src="//s95.cnzz.com/z_stat.php?id=1273219530&web_id=1273219530" language="JavaScript"></script></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script><link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css"><script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script><style>a.gitment-editor-footer-tip{display:none}.gitment-container.gitment-footer-container{display:none}</style><script type="text/javascript">function renderGitment(){new Gitmint({id:window.location.pathname,owner:"Vincentqyw",repo:"Gitment",lang:navigator.language||navigator.systemLanguage||navigator.userLanguage,oauth:{client_secret:"31179aa98fb086ba01a75d116fdd2d846cfc9a0d",client_id:"12c4bbcdc09235fdb668"}}).render("gitment-container")}renderGitment()</script><script type="text/javascript">// Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });</script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"><script>AV.initialize("RQs4FrsjFMNDD6sbzzHlN3ei-gzGzoHsz", "LQziYhODk8GWxR5yDnx4IT0Q");</script><script>function showTime(e){var t=new AV.Query(e),c=[],u=$(".leancloud_visitors");u.each(function(){c.push($(this).attr("id").trim())}),t.containedIn("url",c),t.find().done(function(e){var t=".leancloud-visitors-count";if(0!==e.length){for(var n=0;n<e.length;n++){var o=e[n],i=o.get("url"),s=o.get("time"),r=document.getElementById(i);$(r).find(t).text(s)}for(n=0;n<c.length;n++){i=c[n],r=document.getElementById(i);var l=$(r).find(t);""==l.text()&&l.text(0)}}else u.find(t).text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(i){var e=$(".leancloud_visitors"),s=e.attr("id").trim(),r=e.attr("data-flag-title").trim(),t=new AV.Query(i);t.equalTo("url",s),t.find({success:function(e){if(0<e.length){var t=e[0];t.fetchWhenSave(!0),t.increment("time"),t.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var n=new i,o=new AV.ACL;o.setPublicReadAccess(!0),o.setPublicWriteAccess(!0),n.setACL(o),n.set("title",r),n.set("url",s),n.set("time",1),n.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):1<$(".post-title-link").length&&showTime(e)})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });</script><script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/breakdown.js"></script><script type="text/javascript" src="/js/src/love.js"></script><script>((window.gitter={}).chat={}).options={room:"vincentqin-blog-chat/Lobby"}</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script></body></html>